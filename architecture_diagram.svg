<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="1600" xmlns="http://www.w3.org/2000/svg">
  <!-- Title -->
  <text x="600" y="30" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    SimpleTransformer Architecture
  </text>

  <text x="600" y="55" font-family="Arial, sans-serif" font-size="14" text-anchor="middle" fill="#7f8c8d">
    Data Flow with Tensor Dimensions
  </text>

  <!-- Input Tokens -->
  <g id="input">
    <rect x="500" y="80" width="200" height="60" fill="#3498db" stroke="#2c3e50" stroke-width="2" rx="5"/>
    <text x="600" y="105" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">
      Input Tokens
    </text>
    <text x="600" y="125" font-family="Arial, sans-serif" font-size="14" text-anchor="middle" fill="white">
      idx: (B, T)
    </text>
  </g>

  <!-- Arrow down with split -->
  <line x1="600" y1="140" x2="600" y2="180" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="600" y1="180" x2="400" y2="220" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="600" y1="180" x2="800" y2="220" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Token Embedding -->
  <g id="token-embedding">
    <rect x="250" y="220" width="300" height="80" fill="#e74c3c" stroke="#2c3e50" stroke-width="2" rx="5"/>
    <text x="400" y="245" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">
      Token Embedding Table
    </text>
    <text x="400" y="268" font-family="Arial, sans-serif" font-size="13" text-anchor="middle" fill="white">
      Embedding(vocab_size, n_embed)
    </text>
    <text x="400" y="288" font-family="Arial, sans-serif" font-size="13" text-anchor="middle" fill="white">
      Output: (B, T, n_embed)
    </text>
  </g>

  <!-- Position Embedding -->
  <g id="position-embedding">
    <rect x="650" y="220" width="300" height="80" fill="#e74c3c" stroke="#2c3e50" stroke-width="2" rx="5"/>
    <text x="800" y="245" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">
      Position Embedding Table
    </text>
    <text x="800" y="268" font-family="Arial, sans-serif" font-size="13" text-anchor="middle" fill="white">
      Embedding(block_size, n_embed)
    </text>
    <text x="800" y="288" font-family="Arial, sans-serif" font-size="13" text-anchor="middle" fill="white">
      Output: (T, n_embed)
    </text>
  </g>

  <!-- Arrows converging -->
  <line x1="400" y1="300" x2="600" y2="340" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="800" y1="300" x2="600" y2="340" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Addition operation -->
  <g id="addition">
    <circle cx="600" cy="360" r="25" fill="#f39c12" stroke="#2c3e50" stroke-width="2"/>
    <text x="600" y="370" font-family="Arial, sans-serif" font-size="20" font-weight="bold" text-anchor="middle" fill="white">
      +
    </text>
  </g>

  <!-- Combined embedding label -->
  <text x="600" y="410" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    X = tok_emb + pos_emb
  </text>
  <text x="600" y="430" font-family="Arial, sans-serif" font-size="13" text-anchor="middle" fill="#7f8c8d">
    (B, T, n_embed) = (64, 256, 256)
  </text>

  <!-- Arrow down -->
  <line x1="600" y1="435" x2="600" y2="470" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Multi-Head Attention -->
  <g id="multi-head-attention">
    <rect x="350" y="470" width="500" height="180" fill="#9b59b6" stroke="#2c3e50" stroke-width="2" rx="5"/>
    <text x="600" y="495" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">
      Multi-Head Attention (4 heads)
    </text>

    <!-- Internal detail -->
    <rect x="370" y="510" width="460" height="130" fill="#8e44ad" stroke="#2c3e50" stroke-width="1" rx="3"/>

    <text x="600" y="530" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Each head: Q, K, V = Linear(X) → (B, T, head_size/4) = (64, 256, 16)
    </text>
    <text x="600" y="550" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Attention: wei = softmax(Q @ K^T / √d) → (B, T, T) = (64, 256, 256)
    </text>
    <text x="600" y="570" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Masked (causal): wei.masked_fill(tril == 0, -inf)
    </text>
    <text x="600" y="590" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Output per head: wei @ V → (B, T, 16)
    </text>
    <text x="600" y="610" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Concat 4 heads → (B, T, 64), Project → (B, T, 256)
    </text>
    <text x="600" y="630" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="white">
      Output: (B, T, n_embed) = (64, 256, 256)
    </text>
  </g>

  <!-- Arrow down -->
  <line x1="600" y1="650" x2="600" y2="690" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Feed Forward Network -->
  <g id="feedforward">
    <rect x="350" y="690" width="500" height="140" fill="#16a085" stroke="#2c3e50" stroke-width="2" rx="5"/>
    <text x="600" y="715" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">
      Feed Forward Network
    </text>

    <!-- Internal detail -->
    <rect x="370" y="730" width="460" height="90" fill="#138d75" stroke="#2c3e50" stroke-width="1" rx="3"/>

    <text x="600" y="755" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Linear1: (B, T, n_embed) → (B, T, 4*n_embed)
    </text>
    <text x="600" y="775" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      (64, 256, 256) → (64, 256, 1024)
    </text>
    <text x="600" y="795" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      ReLU → Linear2 → (B, T, n_embed) = (64, 256, 256)
    </text>
    <text x="600" y="815" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="white">
      Output: (B, T, n_embed) = (64, 256, 256)
    </text>
  </g>

  <!-- Arrow down -->
  <line x1="600" y1="830" x2="600" y2="870" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Language Model Head -->
  <g id="lm-head">
    <rect x="400" y="870" width="400" height="80" fill="#e67e22" stroke="#2c3e50" stroke-width="2" rx="5"/>
    <text x="600" y="895" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">
      Language Model Head
    </text>
    <text x="600" y="918" font-family="Arial, sans-serif" font-size="13" text-anchor="middle" fill="white">
      Linear: (B, T, n_embed) → (B, T, vocab_size)
    </text>
    <text x="600" y="938" font-family="Arial, sans-serif" font-size="13" text-anchor="middle" fill="white">
      (64, 256, 256) → (64, 256, 772)
    </text>
  </g>

  <!-- Arrow down -->
  <line x1="600" y1="950" x2="600" y2="990" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Output Logits -->
  <g id="output">
    <rect x="450" y="990" width="300" height="60" fill="#27ae60" stroke="#2c3e50" stroke-width="2" rx="5"/>
    <text x="600" y="1015" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">
      Output Logits
    </text>
    <text x="600" y="1035" font-family="Arial, sans-serif" font-size="14" text-anchor="middle" fill="white">
      (B, T, vocab_size) = (64, 256, 772)
    </text>
  </g>

  <!-- Arrow splits -->
  <line x1="600" y1="1050" x2="600" y2="1080" stroke="#2c3e50" stroke-width="2"/>
  <line x1="600" y1="1080" x2="400" y2="1120" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="600" y1="1080" x2="800" y2="1120" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- Training Path -->
  <g id="training">
    <rect x="200" y="1120" width="400" height="100" fill="#c0392b" stroke="#2c3e50" stroke-width="2" rx="5"/>
    <text x="400" y="1145" font-family="Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" fill="white">
      Training: Loss Computation
    </text>
    <text x="400" y="1168" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Reshape: (B, T, vocab_size) → (B*T, vocab_size)
    </text>
    <text x="400" y="1188" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      (64, 256, 772) → (16384, 772)
    </text>
    <text x="400" y="1208" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Cross-entropy loss with targets (B*T)
    </text>
  </g>

  <!-- Generation Path -->
  <g id="generation">
    <rect x="620" y="1120" width="360" height="140" fill="#2980b9" stroke="#2c3e50" stroke-width="2" rx="5"/>
    <text x="800" y="1145" font-family="Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" fill="white">
      Generation: Sampling
    </text>
    <text x="800" y="1168" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Take last token: logits[:, -1, :] → (B, vocab_size)
    </text>
    <text x="800" y="1188" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      (64, 256, 772) → (1, 772)
    </text>
    <text x="800" y="1208" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Apply temperature: logits / temp
    </text>
    <text x="800" y="1228" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Optional top-k filtering
    </text>
    <text x="800" y="1248" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="white">
      Sample: multinomial(softmax(logits))
    </text>
  </g>

  <!-- Legend -->
  <g id="legend">
    <text x="100" y="1320" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#2c3e50">
      Legend:
    </text>

    <text x="100" y="1350" font-family="Arial, sans-serif" font-size="13" fill="#2c3e50">
      B = batch_size (64)
    </text>
    <text x="100" y="1375" font-family="Arial, sans-serif" font-size="13" fill="#2c3e50">
      T = sequence_length (≤ 256)
    </text>
    <text x="100" y="1400" font-family="Arial, sans-serif" font-size="13" fill="#2c3e50">
      n_embed = embedding dimension (256)
    </text>
    <text x="100" y="1425" font-family="Arial, sans-serif" font-size="13" fill="#2c3e50">
      head_size = attention dimension (64)
    </text>
    <text x="100" y="1450" font-family="Arial, sans-serif" font-size="13" fill="#2c3e50">
      vocab_size = vocabulary size (772)
    </text>
    <text x="100" y="1475" font-family="Arial, sans-serif" font-size="13" fill="#2c3e50">
      block_size = max context length (256)
    </text>
  </g>

  <!-- Parameters Box -->
  <g id="parameters">
    <rect x="600" y="1310" width="550" height="240" fill="#ecf0f1" stroke="#2c3e50" stroke-width="2" rx="5"/>
    <text x="875" y="1335" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">
      Parameter Count
    </text>

    <text x="620" y="1365" font-family="Arial, sans-serif" font-size="12" fill="#2c3e50">
      Token Embedding: 772 × 256 = 197,632
    </text>
    <text x="620" y="1385" font-family="Arial, sans-serif" font-size="12" fill="#2c3e50">
      Position Embedding: 256 × 256 = 65,536
    </text>
    <text x="620" y="1405" font-family="Arial, sans-serif" font-size="12" fill="#2c3e50">
      Multi-Head Attention (4 heads):
    </text>
    <text x="640" y="1425" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">
      Q, K, V per head: 256 × 16 × 3 × 4 = 49,152
    </text>
    <text x="640" y="1440" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">
      Projection: 64 × 256 + 256 = 16,640
    </text>
    <text x="620" y="1460" font-family="Arial, sans-serif" font-size="12" fill="#2c3e50">
      Feed Forward: 256 × 1024 × 2 ≈ 525,568
    </text>
    <text x="620" y="1480" font-family="Arial, sans-serif" font-size="12" fill="#2c3e50">
      LM Head: 256 × 772 + 772 = 198,404
    </text>

    <line x1="620" y1="1490" x2="1130" y2="1490" stroke="#2c3e50" stroke-width="1"/>

    <text x="875" y="1515" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#2c3e50">
      Total: ~1.05M parameters
    </text>

    <text x="875" y="1540" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#7f8c8d">
      (Without feed forward: ~527K parameters)
    </text>
  </g>

  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#2c3e50" />
    </marker>
  </defs>

  <!-- Footer -->
  <text x="600" y="1580" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#95a5a6">
    Note: This is a single-layer transformer. No residual connections or layer normalization included in this simple version.
  </text>
</svg>
